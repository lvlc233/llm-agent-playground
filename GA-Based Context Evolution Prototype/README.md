# 基于遗传算法的上下文进化原型


### 抽象思想
我们定义这样子的一组概念

我们视Agent是一个需要在特定环境中最大化存活概率的由LLM驱动的自主上下文转化器。其目标是将其接触到的环境转化为令自身存活概率最大化的上下文信息。

Agent通过`感知器`和`行动器`来和环境进行交互。`行动器`是Agent主动与环境产生交互的唯一方式,`感知器`则持续的从环境中获取信息并将其转化为可以处理的上下文信息。通过`感知器`和`行动器`的配合,Agent将可以持续的和`环境`产生感知和交互。

环境是指一组包含潜在的或可观测的,有效信息的集合。有效的`信息`的区域决定了环境的大小,信息无法被直接接触和理解,信息必须通过某种媒介转化为观测者可观测的而呈现。潜在的表示一组有效的信息并不会因为观测着的消失而导致环境中缺乏该信息,

Agent的死亡条件是在该策略下无法主动的和当前的环境尝试任何的交互互动。

Agent内部优化这样子的一组策略,这组策略被描述为影响Agent进行感知和行动的内部信息。这组策略会尽量最大化Agent的存活概率。

Agent的所有行为都需要消耗能量,其消耗的数量与其上下文信息成正相关关系。

<!-- 那能量哪来的呢?真的需要指明`感知器和行动器吗?` -->


### 具体策略 (MVP阶段: 纯上下文进化)

在目前阶段，为了验证核心假设，我们简化掉复杂的工具调用，专注于 **Prompt (上下文) 的自然选择与进化**。

**1. 环境 (The Environment)**
*   **定义**: 一个连续的任务场景序列。
*   **形态**: 文件夹结构，包含有序的文本文件（e.g., `step_01.txt`, `step_02.txt`）。
*   **作用**: 提供 Agent 存在的意义和获取能量的来源。
*   **切换机制**: **事件触发**。当 Agent 的输出被裁判判定为“解决了当前步骤的问题”时，系统将环境切换到下一个文件。

**2. Agent (The Organism)**
*   **定义**: 一个由 LLM 驱动的实体，其核心特征由一组文本片段（基因）决定。
*   **基因结构**: Agent 的 Prompt 不是一整块，而是结构化的基因组：
    *   `Identity Gene` (身份基因): 定义 Agent 的角色、性格和思考方式（例如：“你是一个极其严谨的逻辑学家”）。
    *   `Strategy Gene` (策略基因): 定义 Agent 处理信息的方法论（例如：“先列出所有可能性，再逐一排除”）。
    *   `Memory Gene` (记忆基因): （可选）上一代遗留的高价值经验摘要。
*   **存储**: 每个 Agent 拥有独立的文件夹，基因以 `.txt` 或 `.json` 文件形式存储。

**3. 生存机制 (Survival)**
*   **能量 (Energy)**: Agent 的生命值。
    *   **初始能量**: 每个 Agent 出生时拥有的固定能量点数。
    *   **消耗 (Metabolism)**: 每次调用 LLM 进行思考或输出，扣除固定能量（模拟计算成本）。
        *   **基础消耗**: 系数 * Context Length。Prompt 越长，消耗越快。
    *   **获取 (Feeding)**: Agent 的输出如果被系统判定为“有效”（离目标更近），获得能量奖励。
    *   **死亡 (Death)**: 当能量归零或降至阈值以下，Agent 停止活动，被标记为死亡。

**4. 交互循环 (The Loop - Implementation with LangGraph)**
*   利用 `LangGraph` 构建状态机，强调**可观测性**。
*   **State**: 包含 `current_step`, `energy`, `environment_content`, `history`, `is_alive` 等。
*   **Nodes**:
    *   `Perception`: 读取当前环境文件。
    *   `Action (Agent)`: 结合基因生成响应。
    *   `Judgement (Referee)`: 评估响应，更新能量，决定是否进入下一步骤。
*   **Flow**: Perception -> Action -> Judgement -> (if solved) Next Perception / (if not solved) Retry Action.

**5. 进化机制 (Evolution)**
*   **周期**: 当一个时代（Epoch）结束（例如所有 Agent 死亡或达到最大步数）。
*   **选择 (Selection)**: 筛选存活时间最长或剩余能量最多的若干项 Agent 作为“父代”。
*   **繁衍与变异 (Reproduction & Mutation)**:
    *   利用 **Mutator LLM**（变异器）将两个父代的基因文本进行语义融合。
    *   引入随机扰动（Mutation）：随机修改 Prompt 中的形容词、增加新的指令约束或删除部分记忆。
    *   生成新一代 Agent，进入下一个时代。

### 超参数 (Hyperparameters)
1. **初始能量 (Initial Energy)**: e.g., 100 点。
2. **基础消耗 (Step Cost)**: 一个系数和当前Agent的上下文长度成正相关关系,最小为5点。
3. **有效输出判断提示词 (Validity Check Prompt)**: 利用裁判系统判断输出是否有效。判断依据的提示词。
4. **奖励阈值 (Reward Scale)**: 有效输出奖励 10-50 点。
5. **种群大小 (Population Size)**: 每代 4~6 个 Agent。
6. **精英保留率 (Elitism)**: 直接保留上一代最强者的比例。
7. **突变率 (Mutation Rate)**: 新生 Agent 基因发生剧烈文本变化的概率。
8. **时代上限 (Max Epochs)**: 进化的总轮数。

